#!/bin/bash

display_current_date_time() {
    echo "$(date)"
}

openrcfile=$1
tag=$2
ssh_key=$3
no_of_serv=3

display_current_date_time
echo "Starting deployment of $tag using $openrcfile for credentials."
source "$openrcfile"

def_network="${tag}_network"
def_subnet="${tag}_subnet"
def_keypair="${tag}_key"
def_router="${tag}_router"
def_security_grp="${tag}_security_group"
haproxyserv="${tag}_HAproxy"
haproxyserv2="${tag}_HAproxy2"
bastionserv="${tag}_bastion"
devlop_serv="${tag}_dev"
virtualip="${tag}_vip"
sshconf_file="config"
knownhosts="known_hosts"
hostsfile="hosts"

if test -f "$sshconf_file"; then
    rm "$sshconf_file"
fi

if test -f "$knownhosts"; then
    rm "$knownhosts"
fi

if test -f "$hostsfile"; then
    rm "$hostsfile"
fi

checking_keypair=$(openstack keypair list -f value --column Name)
if ! grep -qFx "$def_keypair" <<< "$checking_keypair"; then
    keypair_create=$(openstack keypair create --public-key "$ssh_key" "$def_keypair")
    echo "$(date) keypair created $def_keypair"
else
    echo "$(date) $def_keypair already exists"
fi

checking_networks=$(openstack network list -f value --column Name)
if ! grep -qFx "$def_network" <<< "$checking_networks"; then
    network_create=$(openstack network create --tag "$tag" "$def_network" -f json)
    echo "$(date) network created $def_network"
else
    echo "$(date) $def_network already exists"
fi

checking_subnets=$(openstack subnet list -f value --column Name)
if ! grep -qFx "$def_subnet" <<< "$checking_subnets"; then
    subnet_create=$(openstack subnet create --tag "$tag" --network "$def_network" --subnet-range 10.50.0.0/24 --gateway 10.50.0.1 --allocation-pool start=10.50.0.2,end=10.50.0.100 "$def_subnet" -f json)
    echo "$(date) subnet created $def_subnet"
else
    echo "$(date) $def_subnet already exists"
fi

checking_routers=$(openstack router list -f value --column Name)
if ! grep -qFx "$def_router" <<< "$checking_routers"; then
    router_create=$(openstack router create --tag "$tag" "$def_router")
    echo "$(date) router created $def_router"
    # adding subnet and external gateway to the router
    gatewaysetting=$(openstack router set --external-gateway ext-net "$def_router")
    subnetadding=$(openstack router add subnet "$def_router" "$def_subnet")
else
    echo "$(date) $def_router already exists"
fi
